{% load i18n %}

<div class="ui dividing header">
    {% trans "Settings" %}
    <div class="sub header">{% trans "Configure download preferences and application settings" %}</div>
</div>

<form class="ui form" id="settingsForm" hx-post="/api/settings/update/" hx-trigger="submit">

    <!-- Download Settings -->
    <h3 class="ui header">{% trans "Download Settings" %}</h3>

    <div class="ui grid">
        <div class="eight wide column">
            <div class="field">
                <label>{% trans "Download Directory" %}</label>
                <div class="ui action input">
                    <input type="text" id="downloadDirectory" name="download_directory"
                           value="{{ settings.download_directory|default:'/home/Downloads/Udemy' }}"
                           placeholder="{% trans 'Choose download directory' %}">
                    <button type="button" class="ui icon button" id="browseDirectory">
                        <i class="folder open icon"></i>
                    </button>
                </div>
            </div>

            <div class="field">
                <label>{% trans "Video Quality" %}</label>
                <select class="ui dropdown" id="videoQuality" name="video_quality">
                    <option value="Auto" {% if settings.video_quality == 'Auto' %}selected{% endif %}>{% trans "Auto" %}</option>
                    <option value="2160" {% if settings.video_quality == '2160' %}selected{% endif %}>2160p (4K)</option>
                    <option value="1440" {% if settings.video_quality == '1440' %}selected{% endif %}>1440p (2K)</option>
                    <option value="1080" {% if settings.video_quality == '1080' %}selected{% endif %}>1080p</option>
                    <option value="720" {% if settings.video_quality == '720' %}selected{% endif %}>720p</option>
                    <option value="480" {% if settings.video_quality == '480' %}selected{% endif %}>480p</option>
                    <option value="360" {% if settings.video_quality == '360' %}selected{% endif %}>360p</option>
                    <option value="240" {% if settings.video_quality == '240' %}selected{% endif %}>240p</option>
                </select>
            </div>

            <div class="field">
                <label>{% trans "Download Type" %}</label>
                <select class="ui dropdown" id="downloadType" name="download_type">
                    <option value="0" {% if settings.download_type == 0 %}selected{% endif %}>{% trans "Video and Audio" %}</option>
                    <option value="1" {% if settings.download_type == 1 %}selected{% endif %}>{% trans "Audio Only" %}</option>
                    <option value="2" {% if settings.download_type == 2 %}selected{% endif %}>{% trans "Video Only" %}</option>
                </select>
            </div>

            <div class="field">
                <div class="ui checkbox">
                    <input type="checkbox" id="createSubfolders" name="create_subfolders"
                           {% if settings.create_subfolders %}checked{% endif %}>
                    <label>{% trans "Create course subfolders" %}</label>
                </div>
            </div>

            <div class="field">
                <div class="ui checkbox">
                    <input type="checkbox" id="downloadCaptions" name="download_captions"
                           {% if settings.download_captions %}checked{% endif %}>
                    <label>{% trans "Download captions/subtitles" %}</label>
                </div>
            </div>
        </div>

        <div class="eight wide column">
            <div class="field">
                <label>{% trans "Concurrent Downloads" %}</label>
                <input type="number" id="maxConcurrentDownloads" name="max_concurrent_downloads"
                       value="{{ settings.max_concurrent_downloads|default:3 }}" min="1" max="10">
            </div>

            <div class="field">
                <label>{% trans "Download Speed Limit (MB/s)" %}</label>
                <input type="number" id="speedLimit" name="speed_limit"
                       value="{{ settings.speed_limit|default:0 }}" min="0" step="0.1"
                       placeholder="{% trans '0 for unlimited' %}">
            </div>

            <div class="field">
                <div class="ui checkbox">
                    <input type="checkbox" id="enableRangeDownload" name="enable_range_download"
                           {% if settings.enable_range_download %}checked{% endif %}>
                    <label>{% trans "Enable lecture range selection" %}</label>
                </div>
            </div>

            <div class="two fields" id="rangeDownloadFields" style="{% if not settings.enable_range_download %}display: none;{% endif %}">
                <div class="field">
                    <label>{% trans "Start Lecture" %}</label>
                    <input type="number" id="downloadStart" name="download_start"
                           value="{{ settings.download_start|default:1 }}" min="1">
                </div>
                <div class="field">
                    <label>{% trans "End Lecture" %}</label>
                    <input type="number" id="downloadEnd" name="download_end"
                           value="{{ settings.download_end|default:0 }}" min="0"
                           placeholder="{% trans '0 for all' %}">
                </div>
            </div>
        </div>
    </div>

    <!-- Language Settings -->
    <div class="ui divider"></div>
    <h3 class="ui header">{% trans "Language Settings" %}</h3>

    <div class="ui grid">
        <div class="eight wide column">
            <div class="field">
                <label>{% trans "Interface Language" %}</label>
                <select class="ui dropdown" id="interfaceLanguage" name="interface_language">
                    <option value="en" {% if settings.interface_language == 'en' %}selected{% endif %}>English</option>
                    <option value="es" {% if settings.interface_language == 'es' %}selected{% endif %}>Español</option>
                    <option value="fr" {% if settings.interface_language == 'fr' %}selected{% endif %}>Français</option>
                    <option value="de" {% if settings.interface_language == 'de' %}selected{% endif %}>Deutsch</option>
                    <option value="it" {% if settings.interface_language == 'it' %}selected{% endif %}>Italiano</option>
                    <option value="pt" {% if settings.interface_language == 'pt' %}selected{% endif %}>Português</option>
                    <option value="ru" {% if settings.interface_language == 'ru' %}selected{% endif %}>Русский</option>
                    <option value="ja" {% if settings.interface_language == 'ja' %}selected{% endif %}>日本語</option>
                    <option value="ko" {% if settings.interface_language == 'ko' %}selected{% endif %}>한국어</option>
                    <option value="zh-cn" {% if settings.interface_language == 'zh-cn' %}selected{% endif %}>简体中文</option>
                    <option value="zh-tw" {% if settings.interface_language == 'zh-tw' %}selected{% endif %}>繁體中文</option>
                    <option value="ar" {% if settings.interface_language == 'ar' %}selected{% endif %}>العربية</option>
                </select>
            </div>

            <div class="field">
                <label>{% trans "Preferred Subtitle Language" %}</label>
                <select class="ui dropdown" id="subtitleLanguage" name="subtitle_language">
                    <option value="" {% if not settings.subtitle_language %}selected{% endif %}>{% trans "Auto (match interface)" %}</option>
                    <option value="en" {% if settings.subtitle_language == 'en' %}selected{% endif %}>English</option>
                    <option value="es" {% if settings.subtitle_language == 'es' %}selected{% endif %}>Español</option>
                    <option value="fr" {% if settings.subtitle_language == 'fr' %}selected{% endif %}>Français</option>
                    <option value="de" {% if settings.subtitle_language == 'de' %}selected{% endif %}>Deutsch</option>
                    <option value="it" {% if settings.subtitle_language == 'it' %}selected{% endif %}>Italiano</option>
                    <option value="pt" {% if settings.subtitle_language == 'pt' %}selected{% endif %}>Português</option>
                    <option value="ru" {% if settings.subtitle_language == 'ru' %}selected{% endif %}>Русский</option>
                    <option value="ja" {% if settings.subtitle_language == 'ja' %}selected{% endif %}>日本語</option>
                    <option value="ko" {% if settings.subtitle_language == 'ko' %}selected{% endif %}>한국어</option>
                    <option value="zh-cn" {% if settings.subtitle_language == 'zh-cn' %}selected{% endif %}>简体中文</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Authentication Settings -->
    <div class="ui divider"></div>
    <h3 class="ui header">{% trans "Authentication Settings" %}</h3>

    <div class="ui grid">
        <div class="eight wide column">
            <div class="field">
                <label>{% trans "Udemy Subdomain" %}</label>
                <div class="ui labeled input">
                    <div class="ui label">https://</div>
                    <input type="text" id="udemySubdomain" name="udemy_subdomain"
                           value="{{ user.udemy_subdomain|default:'www' }}" placeholder="www">
                    <div class="ui label">.udemy.com</div>
                </div>
                <div class="ui pointing label">
                    {% trans "For business accounts, use your company subdomain" %}
                </div>
            </div>

            <div class="field">
                <label>{% trans "Access Token" %}</label>
                <div class="ui action input">
                    <input type="password" id="accessToken" name="access_token"
                           value="{% if user.udemy_access_token %}••••••••••••••••{% endif %}"
                           placeholder="{% trans 'Your Udemy access token' %}">
                    <button type="button" class="ui icon button" id="toggleToken">
                        <i class="eye icon"></i>
                    </button>
                </div>
            </div>

            <div class="field">
                <button type="button" class="ui secondary button" id="testConnection">
                    <i class="plug icon"></i>
                    {% trans "Test Connection" %}
                </button>
            </div>
        </div>
    </div>

    <!-- Application Settings -->
    <div class="ui divider"></div>
    <h3 class="ui header">{% trans "Application Settings" %}</h3>

    <div class="ui grid">
        <div class="eight wide column">
            <div class="field">
                <div class="ui checkbox">
                    <input type="checkbox" id="autoCheckUpdates" name="auto_check_updates"
                           {% if settings.auto_check_updates %}checked{% endif %}>
                    <label>{% trans "Automatically check for updates" %}</label>
                </div>
            </div>

            <div class="field">
                <div class="ui checkbox">
                    <input type="checkbox" id="closeAfterDownload" name="close_after_download"
                           {% if settings.close_after_download %}checked{% endif %}>
                    <label>{% trans "Close application after downloads complete" %}</label>
                </div>
            </div>

            <div class="field">
                <div class="ui checkbox">
                    <input type="checkbox" id="enableNotifications" name="enable_notifications"
                           {% if settings.enable_notifications %}checked{% endif %}>
                    <label>{% trans "Enable desktop notifications" %}</label>
                </div>
            </div>

            <div class="field">
                <div class="ui checkbox">
                    <input type="checkbox" id="enableLogging" name="enable_logging"
                           {% if settings.enable_logging %}checked{% endif %}>
                    <label>{% trans "Enable detailed logging" %}</label>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="ui divider"></div>
    <div class="ui buttons">
        <button type="submit" class="ui primary button">
            <i class="save icon"></i>
            {% trans "Save Settings" %}
        </button>
        <button type="button" class="ui button" id="resetSettings">
            <i class="refresh icon"></i>
            {% trans "Reset to Defaults" %}
        </button>
        <button type="button" class="ui red button" id="clearCache">
            <i class="trash icon"></i>
            {% trans "Clear Cache" %}
        </button>
    </div>
</form>

<script>
// Settings specific JavaScript
(function() {
    // Initialize dropdowns
    $('.ui.dropdown').dropdown();

    // Range download toggle
    $('#enableRangeDownload').on('change', function() {
        if ($(this).is(':checked')) {
            $('#rangeDownloadFields').show();
        } else {
            $('#rangeDownloadFields').hide();
        }
    });

    // Token visibility toggle
    $('#toggleToken').on('click', function() {
        const tokenField = $('#accessToken');
        const icon = $(this).find('i');

        if (tokenField.attr('type') === 'password') {
            tokenField.attr('type', 'text');
            icon.removeClass('eye').addClass('eye slash');
        } else {
            tokenField.attr('type', 'password');
            icon.removeClass('eye slash').addClass('eye');
        }
    });

    // Directory browser
    $('#browseDirectory').on('click', function() {
        // This would need to be handled differently in a web app
        // For now, show an input dialog
        const currentPath = $('#downloadDirectory').val();
        const newPath = prompt('{% trans "Enter download directory path:" %}', currentPath);
        if (newPath) {
            $('#downloadDirectory').val(newPath);
        }
    });

    // Test connection
    $('#testConnection').on('click', function() {
        const button = $(this);
        const originalText = button.html();

        button.addClass('loading disabled');

        fetch('/api/auth/test-connection/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                access_token: $('#accessToken').val(),
                subdomain: $('#udemySubdomain').val()
            })
        })
        .then(response => response.json())
        .then(data => {
            button.removeClass('loading disabled').html(originalText);

            if (data.success) {
                showAlert('{% trans "Connection successful!" %}', 'positive');
            } else {
                showAlert('{% trans "Connection failed:" %} ' + data.error, 'negative');
            }
        })
        .catch(error => {
            button.removeClass('loading disabled').html(originalText);
            showAlert('{% trans "Connection test failed:" %} ' + error.message, 'negative');
        });
    });

    // Reset settings
    $('#resetSettings').on('click', function() {
        if (confirm('{% trans "Are you sure you want to reset all settings to defaults?" %}')) {
            fetch('/api/settings/reset/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    showAlert('{% trans "Failed to reset settings:" %} ' + data.error, 'negative');
                }
            });
        }
    });

    // Clear cache
    $('#clearCache').on('click', function() {
        const button = $(this);
        const originalText = button.html();

        if (confirm('{% trans "Are you sure you want to clear all cached data?" %}')) {
            button.addClass('loading disabled');

            fetch('/api/settings/clear-cache/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                button.removeClass('loading disabled').html(originalText);

                if (data.success) {
                    showAlert('{% trans "Cache cleared successfully!" %}', 'positive');
                } else {
                    showAlert('{% trans "Failed to clear cache:" %} ' + data.error, 'negative');
                }
            });
        }
    });

    // Form submission
    $('#settingsForm').on('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = {};

        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }

        // Handle checkboxes
        $('input[type="checkbox"]').each(function() {
            const name = $(this).attr('name');
            data[name] = $(this).is(':checked');
        });

        fetch('/api/settings/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('{% trans "Settings saved successfully!" %}', 'positive');
            } else {
                showAlert('{% trans "Failed to save settings:" %} ' + data.error, 'negative');
            }
        })
        .catch(error => {
            showAlert('{% trans "Failed to save settings:" %} ' + error.message, 'negative');
        });
    });
})();
</script>